version: '3.8'

services:
  # AI Code Review Platform
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-code-review
    ports:
      - "5000:5000"
    environment:
      # Flask Configuration
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      
      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL:-gpt-4-turbo-preview}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.2}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-2000}
      
      # Embedding Configuration
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-local}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - LOCAL_EMBEDDING_MODEL=${LOCAL_EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      
      # Vector DB Configuration
      - VECTOR_DB_TYPE=qdrant
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-code_chunks}
      - QDRANT_USE_MEMORY=false
      
      # Feature Flags
      - ENABLE_ML_ANALYSIS=${ENABLE_ML_ANALYSIS:-true}
      - ENABLE_DL_ANALYSIS=${ENABLE_DL_ANALYSIS:-false}
      - ENABLE_LLM_AGENTS=${ENABLE_LLM_AGENTS:-true}
      - ENABLE_SEMANTIC_SEARCH=${ENABLE_SEMANTIC_SEARCH:-true}
      - ENABLE_CVE_DETECTION=${ENABLE_CVE_DETECTION:-true}
      - ENABLE_SECURITY_REPORTING=${ENABLE_SECURITY_REPORTING:-true}
      
      # Static Analysis Tools
      - ENABLE_BANDIT=${ENABLE_BANDIT:-true}
      - ENABLE_SEMGREP=${ENABLE_SEMGREP:-true}
      - ENABLE_PYLINT=${ENABLE_PYLINT:-false}
      - ENABLE_RUFF=${ENABLE_RUFF:-true}
      
      # Performance
      - MAX_WORKERS=${MAX_WORKERS:-4}
      - CACHE_EMBEDDINGS=${CACHE_EMBEDDINGS:-true}
      
      # GitHub OAuth (Optional)
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      
    volumes:
      # Persistent data volumes
      - ./uploads:/app/uploads
      - ./processed:/app/processed
      - ./output:/app/output
      - ./reports:/app/reports
      - ./instance:/app/instance
      - ./models:/app/models
      - ./vector_db:/app/vector_db
      
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - ai-code-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant-vectordb
    ports:
      - "6333:6333"
      - "6334:6334"  # gRPC port
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - ai-code-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  ai-code-review-network:
    driver: bridge

volumes:
  qdrant_storage:
    driver: local
